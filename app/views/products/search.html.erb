<div class="page-header" id="banner">
  <div class="row">
    <div class="col-lg-12 col-md-12">
      <h3>商品情報を取得</h3>
        <button id="run_search" class="btn btn-primary" style="margin-right: 20px;">取得開始</button>
        <button id="update_data" class="btn btn-primary">データ更新</button>
      <div><br></div>
      <div id="result_table"></div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function(){
    // create table for ASIN
    var convh = {
      "asin": "ASIN",
      "condition" : "商品状態",
      "new_sale1" : "新品過去1ヶ月",
      "new_sale2" : "新品過去2ヶ月",
      "new_sale3" : "新品過去3ヶ月",
      "new_avg3" : "新品3ヶ月平均",
      "used_sale1" : "中古過去1ヶ月",
      "used_sale2" : "中古過去2ヶ月",
      "used_sale3" : "中古過去3ヶ月",
      "used_avg3" : "中古3ヶ月平均",
      "check1" : "チェック1",
      "cart_price" : "カート価格",
      "cart_income" : "カート入金",
      "used_price" : "中古最安値",
      "used_income" : "中古入金",
      "check2" : "チェック2",
      "title" : "商品名",
      "mpn" : "型番",
      "item_image" : "商品画像",
      "new_bid_price" : "新品入札価格",
      "used_bid_price" : "中古入札価格",
      "new_negotiate_price" : "新品交渉価格",
      "used_negotiate_price" : "中古交渉価格"
    }
    var cheaders = [];
    var cwidth = [];
    var mydata = [];
    var colOption = [];
    <% data = Array.new %>
    <% jj = 0 %>
    <% Product.column_names.each_with_index do |name, i| %>
      <% if (i > 1 && i < Product.column_names.length - 6) || (i > Product.column_names.length - 5 ) then %>
        cheaders.push(convh["<%= name %>"]);
        cwidth.push(120);
        <% if i == 12 || i == 17 then %>
          colOption.push({className: "htCenter htMiddle", type:"checkbox", uncheckedTemplate: null});
        <% elsif i == 20 then %>
          colOption.push({className: "htCenter htMiddle", renderer: 'html'});
        <% else %>
          colOption.push({className: "htCenter htMiddle"});
        <% end %>
        <% data.push(@products.pluck(name)) %>
      <% end %>
    <% end %>
    cwidth[1] = 90;
    cwidth[10] = 90;
    cwidth[11] = 90;
    cwidth[12] = 90;
    cwidth[13] = 90;
    cwidth[14] = 90;
    cwidth[15] = 90;
    cwidth[16] = 280;
    cwidth[18] = 100;
    <% data = data.transpose %>

    var maxColnum = cheaders.length;
    var maxRownum = 500;
    var limit = <%= @limit %>;
    if(limit != null){
      if(maxRownum < limit){
        maxRownum = limit;
      }
    }

    <% data.each_with_index do |row, ii| %>
      mydata[<%= ii %>] = [];
      <% row.each_with_index do |col, jj| %>
        mydata[<%= ii %>][<%= jj %>] = "<%= col %>";
        <% if jj == 18 then %>
          mydata[<%= ii %>][<%= jj %>] = '<img src="<%= col %>" height="40" >';
        <% end %>
      <% end %>
    <% end %>

    for(var k = <%= data.length %>; k < <%= data.length %> + 100; k++){
      mydata[k] = [];
      for(var m = 0; m < cheaders.length; m++){
        mydata[k][m] = "";
      }
    }

    var container = document.getElementById('result_table');
    var handsontable = new Handsontable(container, {
      /* オプション */
      width: 1100,
      height: 320,
      contextMenu: true,
      data: mydata,
      rowHeaders: true,
      colHeaders: cheaders,
      maxCols: maxColnum,
      maxRows: maxRownum,
      manualColumnResize: true,
      autoColumnSize: false,
      colWidths: cwidth,
      rowHeights: 60,
      wordWrap: false,
      columns: colOption
    });

    $("#update_data").click(function () {
      alert("record");
      var body = handsontable.getData();
      var head = convh;
      body = JSON.stringify(body);
      head = JSON.stringify(head);
      var myData = {data: body, header: head};
      $.ajax({
        url: "/products/record",
        type: "POST",
        data: myData,
        dataType: "json",
        success: function (result) {
          //mydata[rnum] = result;
          console.log("start");
          var cheaders = Object.keys(convh);
          var temp = [];
        },
        error: function () {
          alert("NG");
        }
      });

    });

    $("#run_search").click(function () {
      alert("Start");
      var body = handsontable.getData();
      body = JSON.stringify(body);
      var rnum = 0;
      repeat(rnum);
    });

    function repeat(rnum){
      var org = handsontable.getData();
      body = JSON.stringify(org);
      var myData = {data: body, rnum: rnum};

      $.ajax({
        url: "/products/get",
        type: "POST",
        data: myData,
        dataType: "json",
        success: function (result) {
          //mydata[rnum] = result;
          console.log("start");
          var cheaders = Object.keys(convh);
          var temp = [];
          console.log(result);
          for(var k = 0; k < cheaders.length; k++){
            console.log(cheaders[k]);
            console.log(result[cheaders[k]]);
            temp[k] = [];
            if(cheaders[k] == "item_image"){
              temp[k] = [rnum, k, '<img src="' + result[cheaders[k]] + '" height="40">'];
              console.log(temp[k]);
            }else{
              temp[k] = [rnum, k, result[cheaders[k]]];
            }

          }
          handsontable.setDataAtCell(temp);
          handsontable.render();
          console.log("end");
          rnum++;
          console.log(org[rnum]);
          if(org[rnum][0] == ""){
            alert("End");
            return;
          }
          repeat(rnum);
        },
        error: function () {
          alert("NG");
        }
      });
    };

  });
</script>
